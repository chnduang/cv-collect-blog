## Chrome 89 æ›´æ–°äº‹ä»¶è§¦å‘é¡ºåºï¼Œå¯¼è‡´99%çš„æ–‡ç« éƒ½é”™äº†ï¼ˆåŒ…æ‹¬MDNï¼‰

> [https://mp.weixin.qq.com/s/FgJv4R-70XuL6st08OKvVg](https://mp.weixin.qq.com/s/FgJv4R-70XuL6st08OKvVg)

## èµ·å› 

æœ€è¿‘æ¥ æºªåœ¨çœ‹äº‹ä»¶ç›¸å…³çš„æ–‡ç« ï¼Œç„¶åå°±è·‘æ¥å’Œæˆ‘è®¨è®ºè¯´ä»¥ä¸‹ä»£ç çš„æ‰§è¡Œæ•ˆæœå’Œç½‘ä¸Šçš„æ–‡ç« ä¸ä¸€è‡´ï¼Œä»£ç å¦‚ä¸‹:

```js
<div>
 <button>123</button>
</div>
<script>

  var btn = document.querySelector('button');
  var div = document.querySelector('div');

  btn.addEventListener('click', function () {
    console.log('bubble', 'btn');
  }, false);
  btn.addEventListener('click', function () {
    console.log('capture', 'btn');
  }, true);
  div.addEventListener('click', function () {
    console.log('bubble', 'div');
  }, false);
  div.addEventListener('click', function () {
    console.log('capture', 'div');
  }, true);

</script>
```

ä»¥ä¸Šæ˜¯ä¸€æ®µå¾ˆç®€å•çš„äº‹ä»¶æ³¨å†Œçš„ä»£ç ï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡» `button`ã€‚

å…ˆä¸çœ‹ç»“æœï¼Œæ€è€ƒä¸€ä¸‹

ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹ç»“æœ

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170938222.gif)

å¯¹äºç»å¤§å¤šæ•°å‰ç«¯è€é¸Ÿæ¥è¯´ï¼Œä¼šè„±å£è€Œå‡ºåœ°è¯´å‡ºä»¥ä¸‹é¡ºåºã€‚

```js
capture div
bubble btn
capture btn
bubble div
```

## æ¢ç´¢

ä½†æ˜¯ä¸ç®¡æ˜¯MDNï¼Œè¿˜æ˜¯ç½‘ä¸Šå¤§å¤šæ•°çš„æ•™ç¨‹è€Œè¨€è¯´çš„éƒ½æ˜¯è¿™ä¸ªé¡ºåºã€‚

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170951306.png)

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170951020.png)

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170952093.png)

å¯¹äºè¿™ä¸ªç°è±¡ï¼Œæˆ‘æ„Ÿåˆ°å¾ˆè¿·æƒ‘ï¼Œæˆ‘ä¾ç¨€è®°å¾—ï¼Œåœ¨å‡ ä¸ªæœˆå‰ï¼ŒChrome è¿˜ä¸æ˜¯è¿™æ ·çš„è¡Œä¸ºï¼Œç›²çŒœæ˜¯ä¸æ˜¯å› ä¸º Chrome ç‰ˆæœ¬çš„é—®é¢˜å‘¢ï¼Ÿ

ä»¥ä¸ŠåŠ¨å›¾çš„ Chrome ç‰ˆæœ¬æ˜¯ 90.0.4430.212

å› æ­¤æˆ‘æ‰¾äº†ä¸ª Chrome ç‰ˆæœ¬ä¸º 84.0.4109.0 è¿›è¡Œæµ‹è¯•ã€‚

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170953762.png)

æœç„¶æ˜¯ç‰ˆæœ¬çš„é—®é¢˜ï¼Œä½†æ˜¯äº‹æƒ…çš„è¿½è¸ªä¾ç„¶å¾ˆéš¾ï¼Œç”±äºæœç´¢äº†è§„èŒƒä»¥åŠæŸ¥äº†è°·æ­Œä¸Šçš„ä¸€äº›èµ„æ–™ï¼Œå¹¶æ²¡æœ‰å¾ˆå¥½åœ°å¸®åŠ©æˆ‘è§£å†³è¿™ä¸ªç–‘æƒ‘ï¼Œæˆ‘ä¸ç¡®å®šæ˜¯å› ä¸º Chrome å¼•å…¥çš„ bug è¿˜æ˜¯å‡ºç°äº†ä»€ä¹ˆé—®é¢˜ã€‚

å› æ­¤æˆ‘å°±å‘ chromium æŠ¥å‘Šäº†è¿™ä¸ªé—®é¢˜ã€‚

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170953310.png)

æœ€ç»ˆåœ¨ Chrome å¼€å‘äººå‘˜çš„å¸®åŠ©ä¸‹ï¼Œæ‰¾åˆ°äº†è¿™ä¸¤ä¸ªè®¨è®º

https://github.com/whatwg/dom/issues/685

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170953448.png)

https://github.com/whatwg/dom/issues/746

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170953898.png)

åœ¨ä¸Šè¿° issues ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ èµ·å› æ˜¯åœ¨ https://bugs.webkit.org/show_bug.cgi?id=174288 ä¸­ï¼Œæœ‰äººæŒ‡å‡ºï¼Œåœ¨ webkit ä¸­å½“å‰çš„äº‹ä»¶æ¨¡å‹ï¼Œä¼šå¯¼è‡´å«æœ‰ Shadow DOM çš„æƒ…å†µä¸‹ï¼Œå­å…ƒç´ çš„æ•è·äº‹ä»¶ä¼šä¼˜å…ˆäºçˆ¶å…ƒç´ çš„æ•è·äº‹ä»¶è§¦å‘ã€‚

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170952684.png)

è€Œåœ¨æ—§æ¨¡å‹ä¸­ï¼Œä¸€æ—¦è¾¾åˆ° AT_TARGET ï¼Œæ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å™¨å°±å°†æŒ‰ç…§é¡ºåºè¢«è§¦å‘ï¼Œè€Œä¸ç®¡ä»–ä»¬æ˜¯å¦è¢«æ ‡è®°ä¸ºæ•è·ã€‚ç”±äº Shadow DOM ä¼šåˆ›å»ºå¤šä¸ª targets ï¼Œå¯¼è‡´äº†äº‹ä»¶æ‰§è¡Œé¡ºåºçš„é”™è¯¯ã€‚

è€Œä¸Šè¿°é—®é¢˜åœ¨ Gecko ï¼ˆMozilla Firefox çš„æ’ç‰ˆå¼•æ“ï¼‰å´è¿è¡Œæ­£å¸¸ï¼ˆå…ˆæ•è·å†å†’æ³¡ï¼‰ã€‚ä¸ºæ­¤ whatwg æå‡ºäº†ä¸€ä¸ªæ–°çš„æ¨¡å‹ç»“æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

![å›¾ç‰‡](https://gitee.com/qdzhou/img-upload/raw/master/images/202202170952452.png)

## ç»“è®º

æ‰€æœ‰çš„ç–‘é—®åˆ°æ­¤éƒ½è¿åˆƒè€Œè§£äº†ï¼Œåˆ°ç°åœ¨ä¸ºä¸»æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹æˆ‘ä»¬çš„é—®é¢˜ã€‚

|      | 1.æŒ‰ç…§æ—§ç‰ˆæœ¬äº‹ä»¶è§¦å‘æœºåˆ¶                       |
| :--- | :--------------------------------------------- |
| è¡¨ç° | ç›®æ ‡å…ƒç´ è§¦å‘äº‹ä»¶é¡ºåºå’Œæ³¨å†Œäº‹ä»¶é¡ºåºæœ‰å…³         |
|      | **2.æ–°çš„çš„äº‹ä»¶è§¦å‘æœºåˆ¶**                       |
| è¡¨ç° | ç›®æ ‡å…ƒç´ è§¦å‘äº‹ä»¶é¡ºåºæŒ‰ç…§å…ˆæ•è·å†å†’æ³¡çš„é¡ºåºè§¦å‘ |

è€Œè¿™ä¸ªç‰ˆæœ¬åˆ†ç•Œçº¿æ˜¯åœ¨ Chrome 89.0.4363.0  å’Œ 89.0.4358.0ã€‚

è€Œ Chrome 89.0.4363.0 æ˜¯åœ¨ 2020-12-22 å‘å¸ƒçš„ï¼Œä¹Ÿå°±æ˜¯æœ€è¿‘å‡ ä¸ªæœˆçš„äº‹æƒ…ï¼Œå› æ­¤è¿‘å‡ ä¸ªæœˆå¦‚æœä½ çš„Chrome æ›´æ–°äº†å°±ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„ç°è±¡ã€‚

åœ¨ Chrome 89.0.4363.0 ä»¥åŠä¹‹åç‰ˆæœ¬ä¸­ï¼Œ**ç›®æ ‡å…ƒç´ çš„è§¦å‘äº‹ä»¶é¡ºåºä¸å†æŒ‰ç…§æ³¨å†Œé¡ºåºè§¦å‘**ï¼**è€Œæ˜¯æŒ‰ç…§å…ˆæ•è·å†å†’æ³¡çš„å½¢å¼ä¾æ¬¡æ‰§è¡Œï¼**

ç„¶åæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ ·ä¿®æ”¹ä¼šç»™æˆ‘ä»¬å¸¦æ¥æ€ä¹ˆæ ·çš„å½±å“ã€‚

1. é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®æ˜¯çš„ï¼Œç½‘ä¸Šä»¥å‰çš„å¤§éƒ¨åˆ†æ–‡ç« å·²ç»ä¸é€‚ç”¨äºå½“ä¸‹çš„ Chrome æ–°ç‰ˆæœ¬äº†ï¼
2. å¦‚æœæˆ‘ä»¬ä¸šåŠ¡ä¸­æœ‰ä¾èµ–ç›¸å…³çš„äº‹ä»¶è§¦å‘é¡ºåºï¼Œè¯·ä»”ç»†æ£€æŸ¥ï¼

ä¸¾ä¸ªğŸŒ°

```js
<div>
 <button>123</button>
</div>
<script>
  var a = [];
  var btn = document.querySelector('button');
  var div = document.querySelector('div');
  btn.addEventListener('click', function () {
    console.log('bubble', 'btn');
    a.push(1);
  }, false);
  btn.addEventListener('click', function () {
    console.log('capture', 'btn');
    a.push(2);
  }, true);
  div.addEventListener('click', function () {
    console.log('bubble', 'div');
  }, false);
  div.addEventListener('click', function () {
    console.log('capture', 'div');
  }, true);
</script>
```

åœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œå½“ button å…ƒç´ è¢«ç‚¹å‡»åï¼Œæœ€ç»ˆ a çš„ç»“æœä¸º [2,1]ï¼Œè€Œåœ¨æ—§ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªç»“æœåˆ™ä¸º [1,2]ã€‚

é‚£å¯¹äºç°é˜¶æ®µä¸€äº›çº¿ä¸Šä»£ç æ”¹å¦‚ä½•æ”¹é€ å‘¢ï¼Ÿ

## æ”¹è¿›æ–¹æ¡ˆ

é‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ— æ³•æ§åˆ¶ç”¨æˆ·ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„æµè§ˆå™¨ï¼Œè¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜è€Œæ¥é¿å…é‡åˆ°çº¿ä¸Šé—®é¢˜å‘¢ï¼Ÿ

å…¶å®å¾ˆç®€å•ã€‚

æˆ‘ä»¬åªéœ€è¦å°†æ‰€æœ‰ç›®æ ‡å…ƒç´ ä»£ç çš„é¡ºåºéƒ½æŒ‰ç…§å…ˆä¹¦å†™æ•è·äº‹ä»¶ä»£ç ï¼Œå†ä¹¦å†™å†’æ³¡äº‹ä»¶ä»£ç ï¼Œå°±å¯ä»¥å…¼å®¹æœ¬æ¬¡çš„æ›´æ–°ã€‚

## æ€è€ƒ

æ‰€æœ‰çš„äº‹æƒ…éƒ½ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œä¸ç®¡æ˜¯å¯¹äºä¸€äº›ç›¸å¯¹å®˜æ–¹çš„æ–‡ç« æˆ–è€…æ•™ç¨‹æˆ‘ä»¬éƒ½è¦æŠ±ä»¥æ€€ç–‘çš„æ€åº¦ï¼Œç›¸ä¿¡æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ã€‚ä¹Ÿè®¸æˆ‘è¿™ç¯‡çš„è¨€è®ºåœ¨å¤šå¹´ä¹‹åä¹Ÿä¼šæ˜¯ä¸€ä¸ªé”™è¯¯ç¤ºä¾‹ï¼Œä½†æ˜¯æ˜¯å¯¹å½“ä¸‹é—®é¢˜çš„ä¸€ä¸ªè®°å½•ã€‚æœ¬æ–‡ä¹Ÿè¿˜æœ‰å¾ˆå¤šä¸è¶³ä¹‹å¤„ï¼Œå¦‚æœæœ‰é—®é¢˜è¯·åœ¨è¯„è®ºä¸­æŒ‡å‡ºã€‚

## å‚è€ƒèµ„æ–™

https://chromium.cypress.io/

https://github.com/whatwg/dom/issues/685

https://bugs.webkit.org/show_bug.cgi?id=174288

https://github.com/whatwg/dom/issues/746

https://dom.spec.whatwg.org/#dispatching-events